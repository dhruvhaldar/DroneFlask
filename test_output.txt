============================= test session starts =============================
platform win32 -- Python 3.13.7, pytest-9.0.2, pluggy-1.6.0
rootdir: E:\Misc\DroneFlask
plugins: base-url-2.1.0, playwright-0.7.2
collected 1 item

tests\test_control.py BROWSER: cdn.tailwindcss.com should not be used in production. To use Tailwind CSS in production, install it as a PostCSS plugin or use the Tailwind CLI: https://tailwindcss.com/docs/installation
BROWSER: [GroupMarkerNotSet(crbug.com/242999)!:A84017009C250000]Automatic fallback to software WebGL has been deprecated. Please use the --enable-unsafe-swiftshader (about:flags#enable-unsafe-swiftshader) flag to opt in to lower security guarantees for trusted content.
BROWSER: [.WebGL-0x762400ecaa00]GL Driver Message (OpenGL, Performance, GL_CLOSE_PATH_NV, High): GPU stall due to ReadPixels
BROWSER: [.WebGL-0x762400ecaa00]GL Driver Message (OpenGL, Performance, GL_CLOSE_PATH_NV, High): GPU stall due to ReadPixels
BROWSER: [.WebGL-0x762400ecaa00]GL Driver Message (OpenGL, Performance, GL_CLOSE_PATH_NV, High): GPU stall due to ReadPixels
BROWSER: [.WebGL-0x762400ecaa00]GL Driver Message (OpenGL, Performance, GL_CLOSE_PATH_NV, High): GPU stall due to ReadPixels (this message will no longer repeat)
Initial Z: 0.0
Applying Thrust (Holding W)...
BROWSER: Emitting control: {thrust: 0.05, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.05, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.15000000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.15000000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.2, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.2, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.25, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.25, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.3, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.3, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.35, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.35, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.39999999999999997, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.39999999999999997, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.44999999999999996, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.44999999999999996, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.49999999999999994, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.49999999999999994, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.5499999999999999, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.5499999999999999, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.6, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.6, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.65, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.65, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.7000000000000001, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.7000000000000001, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.7500000000000001, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.7500000000000001, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.8000000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.8000000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.8500000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.8500000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.9000000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.9000000000000002, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.9500000000000003, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 0.9500000000000003, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
BROWSER: Emitting control: {thrust: 1, roll: 0, pitch: 0, yaw: 0}
Final Z: 0.0
F

================================== FAILURES ===================================
________________________ test_thrust_control[chromium] ________________________

page = <Page url='http://127.0.0.1:5001/'>

    def test_thrust_control(page: Page):
        # Capture console logs
        page.on("console", lambda msg: print(f"BROWSER: {msg.text}"))
    
        # 1. Navigate to App
        page.goto(APP_URL)
    
        # 2. Wait for connection
        expect(page.locator("#status-text")).to_have_text("Online", timeout=10000)
    
        # 3. Check Initial Altitude (should be near 0)
        # The HUD updates rapidly. We get text content.
        z_elem = page.locator("#val-z")
        initial_z = float(z_elem.inner_text())
        print(f"Initial Z: {initial_z}")
    
        # 4. Apply Thrust (Press 'W')
        # We hold it for a while to generate enough force to lift off
        print("Applying Thrust (Holding W)...")
        for _ in range(50): # 50 * 50ms = 2.5s ?? Keydown events need to be consistent
            page.keyboard.press("w")
            page.wait_for_timeout(50) # Manual repeat
    
        # Better: trigger keydown and hold?
        # page.keyboard.down("w")
        # page.wait_for_timeout(2000)
        # page.keyboard.up("w")
    
        # Let's try continuous key presses as the JS handler increments throttle on 'w' keydown
        # JS: if (keys.w) throttle += 0.05; (in updateCmd)
        # updateCmd is called on 'keydown'.
        # Yes, so repeated keydown is needed, OR holding 'w' if OS repeats.
        # Playwright `down` might not trigger repeated events unless we implement it.
        # The JS `window.addEventListener("keydown", ...)` is standard.
        # If we `down('w')`, we fire one event.
        # We need to FIRE multiple keydowns to increase throttle if the logic relies on repeated events.
        # Logic in index.html:
        # window.addEventListener("keydown", (e) => { keys[e.key] = 1; updateCmd(); });
        # if (keys.w) throttle += 0.05;
    
        # It seems `updateCmd` is called on every keydown.
        # So we need MULTIPLE presses to ramp up throttle.
    
        for _ in range(20):
            page.keyboard.press("w")
            page.wait_for_timeout(100)
    
        # 5. Check Altitude Change
        # If throttle works, Z should increase (negative in NED? HUD shows -z)
        # HUD: (-s.z).toFixed(2). So positive HUD = Altitude.
    
        final_z = float(z_elem.inner_text())
        print(f"Final Z: {final_z}")
    
        # Assert
>       assert final_z > initial_z + 0.1, f"Drone did not take off! Init: {initial_z}, Final: {final_z}"
E       AssertionError: Drone did not take off! Init: 0.0, Final: 0.0
E       assert 0.0 > (0.0 + 0.1)

tests\test_control.py:82: AssertionError
=========================== short test summary info ===========================
FAILED tests/test_control.py::test_thrust_control[chromium] - AssertionError:...
============================= 1 failed in 15.51s ==============================
