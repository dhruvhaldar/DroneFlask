<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6DOF Quadcopter Control</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            keyframes: {
              'fade-in-down': {
                '0%': {
                  opacity: '0',
                  transform: 'translateY(-10px)'
                },
                '100%': {
                  opacity: '1',
                  transform: 'translateY(0)'
                },
              }
            },
            animation: {
              'fade-in-down': 'fade-in-down 0.5s ease-out'
            }
          }
        }
      }
    </script>
    <style>
      /* Custom Glassmorphism */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a202c;
      }
      #canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }
      #ui-layer {
        position: relative;
        z-index: 10;
        pointer-events: none;
      }
      .interactive {
        pointer-events: auto;
      }
    </style>
  </head>
  <body class="text-white" tabindex="-1">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4"></div>

    <!-- 3D Canvas -->
    <div id="canvas-container" role="img" aria-label="3D Quadcopter Simulation View"></div>

    <!-- Connection Overlay -->
    <div id="connection-overlay" class="absolute inset-0 flex items-center justify-center z-0 bg-gray-900/60 backdrop-blur-sm transition-opacity duration-500 pointer-events-none">
        <div class="text-center p-6 rounded-2xl border border-white/10 bg-white/5 shadow-2xl flex flex-col items-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 text-red-400 mb-4 animate-pulse">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
            </svg>
            <h2 class="text-3xl font-bold text-white tracking-tight">Signal Lost</h2>
            <p class="text-blue-200 mt-2 font-medium">Searching for drone...</p>
        </div>
    </div>

    <!-- UI Overlay -->
    <div id="ui-layer" class="flex flex-col h-screen p-6 justify-between">
      <!-- Header -->
      <header
        id="ui-header"
        class="glass p-4 rounded-xl max-w-md interactive animate-fade-in-down"
      >
        <h1
          class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500"
        >
          DroneFlask
        </h1>
        <div class="flex items-center gap-2 mt-1">
            <span class="relative flex h-2 w-2">
              <span id="status-ping" class="hidden animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75" aria-hidden="true"></span>
              <span id="status-dot" class="relative inline-flex rounded-full h-2 w-2 bg-yellow-500"></span>
            </span>
            <p class="text-xs text-gray-300">
              Status: <span id="status-text" class="text-yellow-400 font-medium transition-colors duration-500" role="status" aria-live="polite">Connecting...</span>
            </p>
        </div>
      </header>

      <!-- Telemetry Panel -->
      <aside
        id="ui-telemetry"
        aria-label="Telemetry"
        class="absolute top-6 right-6 glass p-4 rounded-xl w-64 interactive space-y-2"
      >
        <h2
          class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
        >
          Telemetry
        </h2>
        <div class="flex justify-between items-center">
          <span>Alt (Z):</span>
          <span id="val-z" class="font-mono tabular-nums text-blue-300 cursor-pointer hover:bg-white/10 rounded px-1 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400" title="Click to copy" tabindex="0" role="button" aria-label="Copy Altitude">0.00</span> m
        </div>
        <div class="flex justify-between items-center">
          <span>Roll:</span>
          <span id="val-phi" class="font-mono tabular-nums text-purple-300 cursor-pointer hover:bg-white/10 rounded px-1 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-400" title="Click to copy" tabindex="0" role="button" aria-label="Copy Roll">0.00</span> rad
        </div>
        <div class="flex justify-between items-center">
          <span>Pitch:</span>
          <span id="val-theta" class="font-mono tabular-nums text-purple-300 cursor-pointer hover:bg-white/10 rounded px-1 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-400" title="Click to copy" tabindex="0" role="button" aria-label="Copy Pitch">0.00</span> rad
        </div>
        <div class="flex justify-between items-center">
          <span>Yaw:</span>
          <span id="val-psi" class="font-mono tabular-nums text-purple-300 cursor-pointer hover:bg-white/10 rounded px-1 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-400" title="Click to copy" tabindex="0" role="button" aria-label="Copy Yaw">0.00</span> rad
        </div>
        <div class="space-y-1 border-t border-white/20 pt-2 mt-2">
            <div class="flex justify-between items-center">
                <span id="lbl-throttle" class="text-sm">Throttle:</span>
                <span class="font-mono tabular-nums text-yellow-300 text-sm"><span id="val-thr">0</span>%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
                <div id="throttle-bar" role="meter" aria-labelledby="lbl-throttle" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="bg-gradient-to-r from-yellow-400 to-red-500 h-1.5 rounded-full transition-all duration-100 ease-out" style="width: 0%"></div>
            </div>
        </div>
      </aside>

      <!-- Camera Reset -->
      <div id="ui-cam-controls" class="absolute bottom-6 right-6 flex flex-col items-center gap-2 interactive group">
        <button
            id="btn-cam-reset"
            class="glass p-3 rounded-full hover:bg-white/10 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 transition-all duration-200 text-gray-300 hover:text-white"
            aria-label="Reset Camera View"
            title="Reset Camera (Home)"
        >
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5l4.72-4.72a.75.75 0 011.28.53v11.38a.75.75 0 01-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 002.25-2.25v-9a2.25 2.25 0 00-2.25-2.25h-9A2.25 2.25 0 002.25 7.5v9a2.25 2.25 0 002.25 2.25z" />
            </svg>
        </button>
        <kbd class="text-[10px] bg-gray-800/50 px-1.5 py-0.5 rounded text-gray-400 font-mono opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-200 select-none">Home</kbd>
      </div>

      <!-- Controls Help -->
      <footer id="ui-controls" class="self-center glass px-6 py-3 rounded-full mb-8 interactive flex flex-wrap items-center justify-center gap-y-2" role="toolbar" aria-label="Flight Controls">
        <!-- Thrust -->
        <div class="flex items-center" role="group" aria-label="Thrust Controls">
            <kbd id="key-w" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Increase Thrust" role="button" tabindex="0" aria-label="Increase Thrust (W)">W</kbd>
            <kbd id="key-s" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs ml-1 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Decrease Thrust" role="button" tabindex="0" aria-label="Decrease Thrust (S)">S</kbd>
            <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold ml-2 mr-3">Thrust</span>
        </div>

        <span class="w-px h-4 bg-gray-600 mx-2" aria-hidden="true"></span>

        <!-- Pitch -->
        <div class="flex items-center" role="group" aria-label="Pitch Controls">
            <kbd id="key-up" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Pitch Down (Forward)" role="button" tabindex="0" aria-label="Pitch Down (Up Arrow)">‚Üë</kbd>
            <kbd id="key-down" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs ml-1 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Pitch Up (Backward)" role="button" tabindex="0" aria-label="Pitch Up (Down Arrow)">‚Üì</kbd>
            <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold ml-2 mr-3">Pitch</span>
        </div>

        <span class="w-px h-4 bg-gray-600 mx-2" aria-hidden="true"></span>

        <!-- Roll -->
        <div class="flex items-center" role="group" aria-label="Roll Controls">
            <kbd id="key-left" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Roll Left" role="button" tabindex="0" aria-label="Roll Left (Left Arrow)">‚Üê</kbd>
            <kbd id="key-right" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs ml-1 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Roll Right" role="button" tabindex="0" aria-label="Roll Right (Right Arrow)">‚Üí</kbd>
            <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold ml-2 mr-3">Roll</span>
        </div>

        <span class="w-px h-4 bg-gray-600 mx-2" aria-hidden="true"></span>

        <!-- Yaw -->
        <div class="flex items-center" role="group" aria-label="Yaw Controls">
            <kbd id="key-a" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Yaw Left" role="button" tabindex="0" aria-label="Yaw Left (A)">A</kbd>
            <kbd id="key-d" class="bg-gray-700 hover:bg-gray-600 cursor-pointer select-none transition-colors duration-100 px-2 py-1 rounded text-xs ml-1 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-blue-400 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900" title="Yaw Right" role="button" tabindex="0" aria-label="Yaw Right (D)">D</kbd>
            <span class="text-[10px] text-gray-400 uppercase tracking-wider font-semibold ml-2 mr-3">Yaw</span>
        </div>

        <span class="w-px h-4 bg-gray-600 mx-2" aria-hidden="true"></span>

        <!-- Actions -->
        <div class="flex items-center gap-2" role="group" aria-label="Flight Actions">
            <button id="btn-takeoff" class="bg-blue-600 hover:bg-blue-500 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900 transition-all duration-200 px-3 py-1 rounded text-xs font-medium pointer-events-auto flex items-center gap-1">
                <span>üöÄ</span> Takeoff
            </button>
            <div class="relative group">
                <button id="btn-reset" class="bg-red-600 hover:bg-red-500 active:scale-95 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900 transition-all duration-200 px-3 py-1 rounded text-xs font-medium pointer-events-auto flex items-center gap-1" title="Emergency Stop" aria-keyshortcuts="Escape">
                    <span>üõë</span> Kill Engines
                </button>
                <kbd class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 text-[10px] bg-gray-800/90 text-red-200 border border-red-500/30 px-1.5 py-0.5 rounded font-mono opacity-0 group-hover:opacity-100 group-focus-within:opacity-100 transition-opacity duration-200 select-none pointer-events-none whitespace-nowrap z-50">Esc</kbd>
            </div>
        </div>
      </footer>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
      // --- 1. Socket IO ---
      const socket = io();
      let droneState = { x: 0, y: 0, z: 0, phi: 0, theta: 0, psi: 0 };
      let isStateDirty = false; // Bolt: Dirty flag to decouple network from render

      socket.on("connect", () => {
        document.getElementById("status-text").innerText = "Online";
        document.getElementById("status-text").className = "text-green-400 font-medium transition-colors duration-500";
        document.getElementById("status-dot").className = "relative inline-flex rounded-full h-2 w-2 bg-green-500";
        document.getElementById("status-ping").className = "animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75";
        document.getElementById("connection-overlay").classList.add("opacity-0");
        updateUIState(true);
        showToast("Connected to Drone Server", "success");
      });

      socket.on("disconnect", () => {
         document.getElementById("status-text").innerText = "Offline";
         document.getElementById("status-text").className = "text-red-400 font-medium transition-colors duration-500";
         document.getElementById("status-dot").className = "relative inline-flex rounded-full h-2 w-2 bg-red-500";
         document.getElementById("status-ping").className = "hidden"; // Stop pinging when offline
         document.getElementById("connection-overlay").classList.remove("opacity-0");
         updateUIState(false);
         showToast("Disconnected from Server", "error");
      });

      function updateUIState(connected) {
        const ids = ['ui-header', 'ui-telemetry', 'ui-cam-controls', 'ui-controls'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                if (connected) {
                    el.classList.remove('opacity-50', 'grayscale', 'pointer-events-none');
                    el.classList.add('interactive');
                } else {
                    el.classList.add('opacity-50', 'grayscale', 'pointer-events-none');
                    el.classList.remove('interactive');
                }
            }
        });
      }

      socket.on("state", (msg) => {
        // msg.data = [x,y,z, vx,vy,vz, phi,theta,psi, p,q,r]
        const d = msg.data;
        if (!d) return;
        droneState.x = d[0];
        droneState.y = d[1];
        droneState.z = d[2];
        droneState.phi = d[3]; // Roll (x axis rot)
        droneState.theta = d[4]; // Pitch (y axis rot)
        droneState.psi = d[5]; // Yaw (z axis rot)

        // Bolt Optimization: Decouple network events from DOM updates
        // Don't call updateHUD directly. Mark state as dirty.
        // updateHUD(droneState);
        isStateDirty = true;
      });

      // Cache HUD elements to reduce DOM access
      const hudElements = {
        z: document.getElementById("val-z"),
        phi: document.getElementById("val-phi"),
        theta: document.getElementById("val-theta"),
        psi: document.getElementById("val-psi"),
      };

      function updateHUD(s) {
        // Optimization: Use cached elements and textContent for better performance
        hudElements.z.textContent = s.z.toFixed(2);
        hudElements.phi.textContent = s.phi.toFixed(3);
        hudElements.theta.textContent = s.theta.toFixed(3);
        hudElements.psi.textContent = s.psi.toFixed(3);
      }

      // --- 2. Controls ---
      const keys = {
        w: 0,
        s: 0,
        a: 0,
        d: 0,
        ArrowUp: 0,
        ArrowDown: 0,
        ArrowLeft: 0,
        ArrowRight: 0,
      };
      let cmd = { thrust: 0, roll: 0, pitch: 0, yaw: 0 }; // Normalized or Ref
      let lastCmdJson = ""; // Optimization: Track last sent command

      function highlightKey(key, pressed) {
        const keyMap = {
          'w': 'key-w', 's': 'key-s', 'a': 'key-a', 'd': 'key-d',
          'ArrowUp': 'key-up', 'ArrowDown': 'key-down',
          'ArrowLeft': 'key-left', 'ArrowRight': 'key-right'
        };
        const id = keyMap[key];
        if (id) {
          const el = document.getElementById(id);
          if (el) {
             if (pressed) el.classList.add('bg-blue-600', 'text-white', 'scale-110');
             else el.classList.remove('bg-blue-600', 'text-white', 'scale-110');
          }
        }
      }

      function setupCopyHandlers() {
        const configs = [
          { id: 'val-z', name: 'Altitude', color: 'text-blue-300' },
          { id: 'val-phi', name: 'Roll', color: 'text-purple-300' },
          { id: 'val-theta', name: 'Pitch', color: 'text-purple-300' },
          { id: 'val-psi', name: 'Yaw', color: 'text-purple-300' }
        ];

        configs.forEach(({ id, name, color }) => {
          const el = document.getElementById(id);
          if (!el) return;

          const handleCopy = () => {
            const val = el.innerText;
            navigator.clipboard.writeText(val).then(() => {
              showToast(`${name} copied!`, 'success');
              el.classList.remove(color);
              el.classList.add('text-green-400', 'font-bold');
              setTimeout(() => {
                  el.classList.remove('text-green-400', 'font-bold');
                  el.classList.add(color);
              }, 500);
            }).catch(() => showToast('Failed to copy', 'error'));
          };

          el.addEventListener('click', handleCopy);
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              handleCopy();
            }
          });
        });
      }
      setupCopyHandlers();

      function setupTouchControls() {
        const keyMap = {
          'key-w': 'w', 'key-s': 's',
          'key-up': 'ArrowUp', 'key-down': 'ArrowDown',
          'key-left': 'ArrowLeft', 'key-right': 'ArrowRight',
          'key-a': 'a', 'key-d': 'd'
        };

        for (const [id, key] of Object.entries(keyMap)) {
          const el = document.getElementById(id);
          if (!el) continue;

          const press = (e) => {
            e.preventDefault(); // Prevent text selection/scrolling
            keys[key] = 1;
            highlightKey(key, true);
            updateCmd();
          };
          const release = (e) => {
            e.preventDefault();
            keys[key] = 0;
            highlightKey(key, false);
            updateCmd();
          };

          el.addEventListener('mousedown', press);
          el.addEventListener('mouseup', release);
          el.addEventListener('mouseleave', release);
          
          // Touch support
          el.addEventListener('touchstart', press);
          el.addEventListener('touchend', release);

          // Keyboard support (Accessibility)
          el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              press(e);
            }
          });
          el.addEventListener('keyup', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
              release(e);
            }
          });
        }
      }
      setupTouchControls();

      // Prevent scrolling with arrows
      window.addEventListener("keydown", (e) => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
            e.preventDefault();
        }
        if (e.key === 'Home') {
            document.getElementById('btn-cam-reset').click();
        }
        if (e.key === 'Escape') {
            document.getElementById('btn-reset').click();
        }
        keys[e.key] = 1;
        highlightKey(e.key, true);
        updateCmd();
      });
      window.addEventListener("keyup", (e) => {
        keys[e.key] = 0;
        highlightKey(e.key, false);
        updateCmd();
      });

      function updateCmd() {
        // Logic
        // Thrust: W(+), S(-) (Accumulate? Or Direct?)
        // Interactive usually means Direct or Rate.
        // Let's do simple increment for Thrust (Throttle)

        // Roll/Pitch: Arrows (Direct, spring back?)
        const rollMax = 0.5; // rad (~30 deg)
        const pitchMax = 0.5;

        // Roll: Left/Right
        let r = 0;
        if (keys.ArrowLeft) r = -rollMax;
        if (keys.ArrowRight) r = rollMax;

        // Pitch: Up/Down
        let p = 0;
        if (keys.ArrowUp) p = pitchMax; // Pitch up? Or forward?
        // Usually Forward (Stick Up) -> Pitch Down (Nose Down) -> Move Forward
        // Let's map Up -> Pitch Down (-theta)
        if (keys.ArrowDown) p = -pitchMax;

        // Yaw: A/D (Rate)
        let y = 0;
        if (keys.a) y = -1.0;
        if (keys.d) y = 1.0;

        // Thrust:
        // We need a persistent throttle variable
        if (keys.w) throttle += 0.02; // Smoother increase
        if (keys.s) throttle -= 0.02;
        throttle = Math.max(0, Math.min(1, throttle));

        // Update UI
        const pct = Math.round(throttle * 100);
        document.getElementById('val-thr').innerText = pct;
        const bar = document.getElementById('throttle-bar');
        if (bar) {
            bar.style.width = `${pct}%`;
            bar.setAttribute('aria-valuenow', pct);
        }

        cmd.thrust = throttle;
        cmd.roll = r;
        cmd.pitch = p; // Direct angle command
        cmd.yaw = y; // Yaw Rate command


        // Optimization: Only emit if command changed to save bandwidth
        const currentCmdJson = JSON.stringify(cmd);
        if (currentCmdJson !== lastCmdJson) {
            socket.emit("control", cmd);
            lastCmdJson = currentCmdJson;
        }
      }

      let throttle = 0.0; // 0 to 1

      // Takeoff Button
      document.getElementById('btn-takeoff').addEventListener('click', () => {
          throttle = 0.40; // Jump to 40%
          updateCmd(); // Send immediately
          showToast("üöÄ Initiating Takeoff Sequence (40% Thrust)", "info");
          document.body.focus();
      });

      // Reset Button (Reloads page effectively for now, but really should reset sim)
      document.getElementById('btn-reset').addEventListener('click', () => {
         socket.emit('reset_sim');
         // Also reset local state
         throttle = 0.0;
         droneState = { x: 0, y: 0, z: 0, phi: 0, theta: 0, psi: 0 };
         updateCmd();
         showToast("üõë Engines Cut", "error");
      });

      // Camera Reset
      document.getElementById('btn-cam-reset').addEventListener('click', () => {
          controls.reset();
          camera.position.set(0, 2, 5); // Ensure default if controls.reset() doesn't do it all
          controls.target.set(0, 0, 0); // Reset target
          controls.update();
          showToast("Camera View Reset", "info");
      });

      // --- Toast Notification System ---
      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');

        // Colors
        let colors = 'text-blue-200 border-blue-500/30 bg-blue-900/40';
        if (type === 'success') colors = 'text-green-200 border-green-500/30 bg-green-900/40';
        if (type === 'error') colors = 'text-red-200 border-red-500/30 bg-red-900/40';

        el.className = `glass px-4 py-3 rounded-xl shadow-lg border backdrop-blur-md transform transition-all duration-300 translate-y-2 opacity-0 flex items-center gap-2 pointer-events-auto ${colors}`;
        el.setAttribute('role', type === 'error' ? 'alert' : 'status');

        const icon = type === 'error' ? '‚ö†Ô∏è' : (type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è');
        el.innerHTML = `
            <span class="text-lg" aria-hidden="true">${icon}</span>
            <span class="flex-1">${message}</span>
            <button type="button" onclick="this.parentElement.remove()" class="ml-2 opacity-50 hover:opacity-100 p-1 hover:bg-white/10 rounded transition-opacity focus:outline-none focus:ring-2 focus:ring-white/50" aria-label="Dismiss">‚úï</button>
        `;

        container.appendChild(el);

        // Animate in
        requestAnimationFrame(() => {
            el.classList.remove('translate-y-2', 'opacity-0');
        });

        // Remove after 3s
        setTimeout(() => {
            if (el.parentElement) {
                el.classList.add('opacity-0', '-translate-y-2');
                setTimeout(() => {
                    if (el.parentElement) el.remove();
                }, 300);
            }
        }, 3000);
      }

      // --- 3. Three.js Visualization ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a202c);
      scene.fog = new THREE.Fog(0x1a202c, 10, 50);

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document
        .getElementById("canvas-container")
        .appendChild(renderer.domElement);

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      // Grid
      const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x222222);
      scene.add(gridHelper);

      // Quadcopter Model (Simple Group)
      const drone = new THREE.Group();

      // Arms
      const armGeo = new THREE.BoxGeometry(0.5, 0.05, 0.05);
      const armMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6 }); // Blue-500
      const arm1 = new THREE.Mesh(armGeo, armMat);
      const arm2 = new THREE.Mesh(armGeo, armMat);
      arm2.rotation.y = Math.PI / 2;
      drone.add(arm1);
      drone.add(arm2);

      // Center Body
      const bodyGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.05, 16);
      const bodyMat = new THREE.MeshStandardMaterial({ color: 0xef4444 }); // Red-500
      const body = new THREE.Mesh(bodyGeo, bodyMat);
      drone.add(body);

      // Props (Visual only)
      const propGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.01, 8);
      const propMat = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.5,
      });
      const props = [];
      const offsets = [
        [0.25, 0],
        [-0.25, 0],
        [0, 0.25],
        [0, -0.25],
      ];
      offsets.forEach((pos) => {
        const p = new THREE.Mesh(propGeo, propMat);
        p.position.set(pos[0], 0.05, pos[1]);
        drone.add(p);
        props.push(p);
      });

      scene.add(drone);

      // Camera Logic
      camera.position.set(0, 2, 5);
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Animation Loop
      function animate() {
        requestAnimationFrame(animate);

        // Bolt Optimization: Only update DOM if state changed, synced with render loop
        if (isStateDirty) {
          updateHUD(droneState);
          isStateDirty = false;
        }

        // Update Drone Transform using latest Server State
        // Coordinate System Mapping:
        // Sim: NED (x=North, y=East, z=Down)? Or standard?
        // Quad Viz usually: X=Forward, Y=Left, Z=Up.
        // If Sim is standard aerospace (z down), we map:
        // ThreeJS: Y is Up.
        // Sim x -> Three -z (Forward)
        // Sim y -> Three x (Right)
        // Sim z -> Three y (Up, inverted)

        // Let's assume Sim is: Z UP (for ease, code seemed so)
        // visualization.py used: p.z IS up.
        // So direct mapping: x->x, y->-z(forward in three?), z->y(up in three)
        // Matplotlib 3D: Z is Up. X/Y ground.

        // ThreeJS default: Y Up. -Z Forward. X Right.
        // Mapping:
        // Sim X -> Three ?
        // Let's just try direct mapping first:
        drone.position.x = droneState.x;
        drone.position.z = droneState.y; // Y in sim is usually lateral
        drone.position.y = droneState.z; // Z in sim is Up

        // Rotation (Euler XYZ?)
        // ThreeJS Euler is usually XYZ.
        drone.rotation.x = droneState.phi;
        drone.rotation.z = droneState.theta; // Pitch often Y in Three?
        drone.rotation.y = droneState.psi;

        // Spin props
        props.forEach((p) => (p.rotation.y += 0.5));

        // Camera follow
        // camera.lookAt(drone.position);

        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Handle Resize
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });

      // Initialize UI state
      updateUIState(false);
    </script>
  </body>
</html>