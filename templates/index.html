<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>6DOF Quadcopter Control</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom Glassmorphism */
      .glass {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      body {
        margin: 0;
        overflow: hidden;
        background-color: #1a202c;
      }
      #canvas-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }
      #ui-layer {
        position: relative;
        z-index: 10;
        pointer-events: none;
      }
      .interactive {
        pointer-events: auto;
      }
    </style>
  </head>
  <body class="text-white">
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4"></div>

    <!-- 3D Canvas -->
    <div id="canvas-container" role="img" aria-label="3D Quadcopter Simulation View"></div>

    <!-- UI Overlay -->
    <div id="ui-layer" class="flex flex-col h-screen p-6 justify-between">
      <!-- Header -->
      <div
        class="glass p-4 rounded-xl max-w-md interactive animate-fade-in-down"
      >
        <h1
          class="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500"
        >
          DroneFlask
        </h1>
        <p class="text-xs text-gray-300 mt-1">
          Status: <span id="status-text" class="text-green-400" role="status" aria-live="polite">Connected</span>
        </p>
      </div>

      <!-- Telemetry Panel -->
      <div
        class="absolute top-6 right-6 glass p-4 rounded-xl w-64 interactive space-y-2"
      >
        <h2
          class="text-sm font-semibold text-gray-400 uppercase tracking-wider"
        >
          Telemetry
        </h2>
        <div class="flex justify-between">
          <span>Alt (Z):</span>
          <span id="val-z" class="font-mono text-blue-300">0.00</span> m
        </div>
        <div class="flex justify-between">
          <span>Roll:</span>
          <span id="val-phi" class="font-mono text-purple-300">0.00</span> rad
        </div>
        <div class="flex justify-between">
          <span>Pitch:</span>
          <span id="val-theta" class="font-mono text-purple-300">0.00</span> rad
        </div>
        <div class="flex justify-between">
          <span>Yaw:</span>
          <span id="val-psi" class="font-mono text-purple-300">0.00</span> rad
        </div>
        <div class="space-y-1 border-t border-white/20 pt-2 mt-2">
            <div class="flex justify-between items-center">
                <span class="text-sm">Throttle:</span>
                <span class="font-mono text-yellow-300 text-sm"><span id="val-thr">0</span>%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-1.5 overflow-hidden">
                <div id="throttle-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" class="bg-gradient-to-r from-yellow-400 to-red-500 h-1.5 rounded-full transition-all duration-100 ease-out" style="width: 0%"></div>
            </div>
        </div>
      </div>

      <!-- Controls Help -->
      <div class="self-center glass px-6 py-3 rounded-full mb-8 interactive">
        <kbd id="key-w" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">W</kbd>
        <kbd id="key-s" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">S</kbd> Thrust (Hold/Tap)
        <span class="mx-2">|</span>
        <kbd id="key-up" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">‚Üë</kbd>
        <kbd id="key-down" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">‚Üì</kbd> Pitch
        <span class="mx-2">|</span>
        <kbd id="key-left" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">‚Üê</kbd>
        <kbd id="key-right" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">‚Üí</kbd> Roll
        <span class="mx-2">|</span>
        <kbd id="key-a" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">A</kbd>
        <kbd id="key-d" class="bg-gray-700 transition-colors duration-100 px-2 py-1 rounded text-xs">D</kbd> Yaw
        <span class="mx-2">|</span>
        <button id="btn-takeoff" class="bg-blue-600 hover:bg-blue-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900 transition-all duration-200 px-2 py-1 rounded text-xs ml-2 pointer-events-auto">Takeoff (40%)</button>
        <button id="btn-reset" class="bg-red-600 hover:bg-red-500 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-gray-900 transition-all duration-200 px-2 py-1 rounded text-xs ml-2 pointer-events-auto">Kill Engines</button>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
      // --- 1. Socket IO ---
      const socket = io();
      let droneState = { x: 0, y: 0, z: 0, phi: 0, theta: 0, psi: 0 };

      socket.on("connect", () => {
        document.getElementById("status-text").innerText = "Online";
        document.getElementById("status-text").className = "text-green-400";
        showToast("Connected to Drone Server", "success");
      });

      socket.on("disconnect", () => {
         document.getElementById("status-text").innerText = "Offline";
         document.getElementById("status-text").className = "text-red-400";
         showToast("Disconnected from Server", "error");
      });

      socket.on("state", (msg) => {
        // msg.data = [x,y,z, vx,vy,vz, phi,theta,psi, p,q,r]
        const d = msg.data;
        if (!d) return;
        droneState.x = d[0];
        droneState.y = d[1];
        droneState.z = d[2];
        droneState.phi = d[6]; // Roll (x axis rot)
        droneState.theta = d[7]; // Pitch (y axis rot)
        droneState.psi = d[8]; // Yaw (z axis rot)

        updateHUD(droneState);
      });

      function updateHUD(s) {
        document.getElementById("val-z").innerText = s.z.toFixed(2); // Sim Z is Up (based on Viz logic)
        document.getElementById("val-phi").innerText = s.phi.toFixed(3);
        document.getElementById("val-theta").innerText = s.theta.toFixed(3);
        document.getElementById("val-psi").innerText = s.psi.toFixed(3);
      }

      // --- 2. Controls ---
      const keys = {
        w: 0,
        s: 0,
        a: 0,
        d: 0,
        ArrowUp: 0,
        ArrowDown: 0,
        ArrowLeft: 0,
        ArrowRight: 0,
      };
      let cmd = { thrust: 0, roll: 0, pitch: 0, yaw: 0 }; // Normalized or Ref

      function highlightKey(key, pressed) {
        const keyMap = {
          'w': 'key-w', 's': 'key-s', 'a': 'key-a', 'd': 'key-d',
          'ArrowUp': 'key-up', 'ArrowDown': 'key-down',
          'ArrowLeft': 'key-left', 'ArrowRight': 'key-right'
        };
        const id = keyMap[key];
        if (id) {
          const el = document.getElementById(id);
          if (el) {
             if (pressed) el.classList.add('bg-blue-600', 'text-white', 'scale-110');
             else el.classList.remove('bg-blue-600', 'text-white', 'scale-110');
          }
        }
      }

      function setupTouchControls() {
        const keyMap = {
          'key-w': 'w', 'key-s': 's',
          'key-up': 'ArrowUp', 'key-down': 'ArrowDown',
          'key-left': 'ArrowLeft', 'key-right': 'ArrowRight',
          'key-a': 'a', 'key-d': 'd'
        };

        for (const [id, key] of Object.entries(keyMap)) {
          const el = document.getElementById(id);
          if (!el) continue;

          const press = (e) => {
            e.preventDefault(); // Prevent text selection/scrolling
            keys[key] = 1;
            highlightKey(key, true);
            updateCmd();
          };
          const release = (e) => {
            e.preventDefault();
            keys[key] = 0;
            highlightKey(key, false);
            updateCmd();
          };

          el.addEventListener('mousedown', press);
          el.addEventListener('mouseup', release);
          el.addEventListener('mouseleave', release);
          
          // Touch support
          el.addEventListener('touchstart', press);
          el.addEventListener('touchend', release);
        }
      }
      setupTouchControls();

      // Prevent scrolling with arrows
      window.addEventListener("keydown", (e) => {
        if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
            e.preventDefault();
        }
        keys[e.key] = 1;
        highlightKey(e.key, true);
        updateCmd();
      });
      window.addEventListener("keyup", (e) => {
        keys[e.key] = 0;
        highlightKey(e.key, false);
        updateCmd();
      });

      function updateCmd() {
        // Logic
        // Thrust: W(+), S(-) (Accumulate? Or Direct?)
        // Interactive usually means Direct or Rate.
        // Let's do simple increment for Thrust (Throttle)

        // Roll/Pitch: Arrows (Direct, spring back?)
        const rollMax = 0.5; // rad (~30 deg)
        const pitchMax = 0.5;

        // Roll: Left/Right
        let r = 0;
        if (keys.ArrowLeft) r = -rollMax;
        if (keys.ArrowRight) r = rollMax;

        // Pitch: Up/Down
        let p = 0;
        if (keys.ArrowUp) p = pitchMax; // Pitch up? Or forward?
        // Usually Forward (Stick Up) -> Pitch Down (Nose Down) -> Move Forward
        // Let's map Up -> Pitch Down (-theta)
        if (keys.ArrowDown) p = -pitchMax;

        // Yaw: A/D (Rate)
        let y = 0;
        if (keys.a) y = -1.0;
        if (keys.d) y = 1.0;

        // Thrust:
        // We need a persistent throttle variable
        if (keys.w) throttle += 0.02; // Smoother increase
        if (keys.s) throttle -= 0.02;
        throttle = Math.max(0, Math.min(1, throttle));

        // Update UI
        const pct = Math.round(throttle * 100);
        document.getElementById('val-thr').innerText = pct;
        const bar = document.getElementById('throttle-bar');
        if (bar) {
            bar.style.width = `${pct}%`;
            bar.setAttribute('aria-valuenow', pct);
        }

        cmd.thrust = throttle;
        cmd.roll = r;
        cmd.pitch = p; // Direct angle command
        cmd.yaw = y; // Yaw Rate command


        
        console.log("Emitting control:", cmd);
        socket.emit("control", cmd);
      }

      let throttle = 0.0; // 0 to 1

      // Takeoff Button
      document.getElementById('btn-takeoff').addEventListener('click', () => {
          throttle = 0.40; // Jump to 40%
          updateCmd(); // Send immediately
          showToast("üöÄ Initiating Takeoff Sequence (40% Thrust)", "info");
          document.body.focus();
      });

      // Reset Button (Reloads page effectively for now, but really should reset sim)
      document.getElementById('btn-reset').addEventListener('click', () => {
         socket.emit('reset_sim');
         // Also reset local state
         throttle = 0.0;
         droneState = { x: 0, y: 0, z: 0, phi: 0, theta: 0, psi: 0 };
         updateCmd();
         showToast("üõë Engines Cut", "error");
      });

      // --- Toast Notification System ---
      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const el = document.createElement('div');

        // Colors
        let colors = 'text-blue-200 border-blue-500/30 bg-blue-900/40';
        if (type === 'success') colors = 'text-green-200 border-green-500/30 bg-green-900/40';
        if (type === 'error') colors = 'text-red-200 border-red-500/30 bg-red-900/40';

        el.className = `glass px-4 py-3 rounded-xl shadow-lg border backdrop-blur-md transform transition-all duration-300 translate-y-2 opacity-0 flex items-center gap-2 ${colors}`;
        el.setAttribute('role', 'alert');
        el.innerHTML = `<span class="text-lg">${type === 'error' ? '‚ö†Ô∏è' : (type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è')}</span> <span>${message}</span>`;

        container.appendChild(el);

        // Animate in
        requestAnimationFrame(() => {
            el.classList.remove('translate-y-2', 'opacity-0');
        });

        // Remove after 3s
        setTimeout(() => {
            el.classList.add('opacity-0', '-translate-y-2');
            setTimeout(() => el.remove(), 300);
        }, 3000);
      }

      // --- 3. Three.js Visualization ---
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x1a202c);
      scene.fog = new THREE.Fog(0x1a202c, 10, 50);

      const camera = new THREE.PerspectiveCamera(
        75,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      );
      const renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true,
      });
      renderer.setSize(window.innerWidth, window.innerHeight);
      document
        .getElementById("canvas-container")
        .appendChild(renderer.domElement);

      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
      scene.add(ambientLight);
      const dirLight = new THREE.DirectionalLight(0xffffff, 1);
      dirLight.position.set(5, 10, 7);
      scene.add(dirLight);

      // Grid
      const gridHelper = new THREE.GridHelper(50, 50, 0x444444, 0x222222);
      scene.add(gridHelper);

      // Quadcopter Model (Simple Group)
      const drone = new THREE.Group();

      // Arms
      const armGeo = new THREE.BoxGeometry(0.5, 0.05, 0.05);
      const armMat = new THREE.MeshStandardMaterial({ color: 0x3b82f6 }); // Blue-500
      const arm1 = new THREE.Mesh(armGeo, armMat);
      const arm2 = new THREE.Mesh(armGeo, armMat);
      arm2.rotation.y = Math.PI / 2;
      drone.add(arm1);
      drone.add(arm2);

      // Center Body
      const bodyGeo = new THREE.CylinderGeometry(0.1, 0.1, 0.05, 16);
      const bodyMat = new THREE.MeshStandardMaterial({ color: 0xef4444 }); // Red-500
      const body = new THREE.Mesh(bodyGeo, bodyMat);
      drone.add(body);

      // Props (Visual only)
      const propGeo = new THREE.CylinderGeometry(0.15, 0.15, 0.01, 8);
      const propMat = new THREE.MeshBasicMaterial({
        color: 0xffffff,
        transparent: true,
        opacity: 0.5,
      });
      const props = [];
      const offsets = [
        [0.25, 0],
        [-0.25, 0],
        [0, 0.25],
        [0, -0.25],
      ];
      offsets.forEach((pos) => {
        const p = new THREE.Mesh(propGeo, propMat);
        p.position.set(pos[0], 0.05, pos[1]);
        drone.add(p);
        props.push(p);
      });

      scene.add(drone);

      // Camera Logic
      camera.position.set(0, 2, 5);
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Animation Loop
      function animate() {
        requestAnimationFrame(animate);

        // Update Drone Transform using latest Server State
        // Coordinate System Mapping:
        // Sim: NED (x=North, y=East, z=Down)? Or standard?
        // Quad Viz usually: X=Forward, Y=Left, Z=Up.
        // If Sim is standard aerospace (z down), we map:
        // ThreeJS: Y is Up.
        // Sim x -> Three -z (Forward)
        // Sim y -> Three x (Right)
        // Sim z -> Three y (Up, inverted)

        // Let's assume Sim is: Z UP (for ease, code seemed so)
        // visualization.py used: p.z IS up.
        // So direct mapping: x->x, y->-z(forward in three?), z->y(up in three)
        // Matplotlib 3D: Z is Up. X/Y ground.

        // ThreeJS default: Y Up. -Z Forward. X Right.
        // Mapping:
        // Sim X -> Three ?
        // Let's just try direct mapping first:
        drone.position.x = droneState.x;
        drone.position.z = droneState.y; // Y in sim is usually lateral
        drone.position.y = droneState.z; // Z in sim is Up

        // Rotation (Euler XYZ?)
        // ThreeJS Euler is usually XYZ.
        drone.rotation.x = droneState.phi;
        drone.rotation.z = droneState.theta; // Pitch often Y in Three?
        drone.rotation.y = droneState.psi;

        // Spin props
        props.forEach((p) => (p.rotation.y += 0.5));

        // Camera follow
        // camera.lookAt(drone.position);

        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Handle Resize
      window.addEventListener("resize", () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
